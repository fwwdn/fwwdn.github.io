<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>fwwdn&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="fwwdn's blog">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="fwwdn's blog">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="fwwdn's blog">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="fwwdn&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/me.png" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">fwwdn</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/tags/随笔">随笔</a></li>
				        
							<li><a href="/tags/相册">相册</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/fwwdn" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/u/1713855955/home?wvr=5" title="weibo">weibo</a>
					        
								<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/fwwdn" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/NoSQL/" style="font-size: 10px;">NoSQL</a> <a href="/tags/NoSQL-Redis/" style="font-size: 10px;">NoSQL Redis</a> <a href="/tags/Tools/" style="font-size: 20px;">Tools</a> <a href="/tags/java/" style="font-size: 16.67px;">java</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/后端技术/" style="font-size: 10px;">后端技术</a> <a href="/tags/收藏/" style="font-size: 13.33px;">收藏</a> <a href="/tags/架构/" style="font-size: 13.33px;">架构</a> <a href="/tags/电商/" style="font-size: 10px;">电商</a> <a href="/tags/随笔/" style="font-size: 13.33px;">随笔</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://dbanotes.net/">冯大辉</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">随身云后端开发，关注的技术：Linux、java、memcached、redis,、mysql、 solr。</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">fwwdn</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="/img/me.png" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">fwwdn</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags/随笔">随笔</a></li>
		        
					<li><a href="/tags/相册">相册</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/fwwdn" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/u/1713855955/home?wvr=5" title="weibo">weibo</a>
			        
						<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/fwwdn" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-data-structures-and-algorithms" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/06/24/data-structures-and-algorithms/" class="article-date">
  	<time datetime="2015-06-24T14:41:04.000Z" itemprop="datePublished">2015-06-24</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/24/data-structures-and-algorithms/">Data Structures And Algorithms</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="常见数据结构">常见数据结构</h2><ul>
<li>线性：数组，链表，队列，堆栈，块状数组（数组+链表），hash表，双端队列，位图（bitmap）</li>
<li>树：堆（大顶堆、小顶堆），trie树（字母树or字典树），后缀树，后缀树组，二叉排序/查找树，B+/B-，AVL树，Treap，红黑树，splay树，线段树，树状数组</li>
<li>图：图</li>
<li>其它：并查集</li>
</ul>
<h2 id="常见算法">常见算法</h2><ul>
<li>基本思想：枚举，递归，分治，模拟，贪心，动态规划，剪枝，回溯</li>
<li>图算法：深度优先遍历与广度优先遍历， 最短路径，最小生成树，拓扑排序</li>
<li>字符串算法：字符串查找，hash算法，KMP算法</li>
<li>排序算法：冒泡，插入，选择，快排，归并排序，堆排序，桶排序</li>
<li>动态规划：背包问题，最长公共子序列，最优二分检索树</li>
<li>数论问题：素数问题，整数问题，进制转换，同余模运算，</li>
<li>排列组合：排列和组合算法</li>
<li>其它：LCA与RMQ问题</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-monolithic-vs-microservice" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/06/23/monolithic-vs-microservice/" class="article-date">
  	<time datetime="2015-06-23T13:49:47.000Z" itemprop="datePublished">2015-06-23</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/23/monolithic-vs-microservice/">monolithic vs microservice</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>微服务（ Microservice ）是最近几年出现在架构领域的新的术语，无数的人根据自己的理解去解读微服务，一时间它成了秒杀单体应用（Monolithic ）、解决任何问题的灵丹妙药。</p>
<p>微服务真的是终极解决方案？单体应用真的没必要？什么时候适合单体应用？什么时候需要拆分服务？一个大的分布式系统如何从简单的单体应用成长为复杂的分布式微服务？本文将尝试回答这些问题。</p>
<p><img src="http://img2001.static.suishenyun.net/25ece6711a70a7938cb1105810f59bd3/047f460133c6d0f9184d9ebc684867a0.png!w480.jpg" alt=""></p>
<p>用 1 个程序实现所有的功能，这是一个单体（Monolithic ）应用。运行程序，所有的功能都属于同一个进程，它们之间的调用属于进程内通信。这就保证功能模块之间的同步通信，调用速度快。单体应用可能存在的问题包括：<br>一个进程集成了所有的功能，意味着它需要更多的系统资源。是否存在能够提供这些资源的主机？用户是否能够或者愿意负担这样的主机？<br>修改或者升级任何功能模块，必须先停止运行整个应用，导致应用暂时不可用。</p>
<p>把所有的功能划分为 n 个部分，分别用 1 个程序实现，这就是一个多体应用。多体应用既可以部署在单机上，也可以部署在多机上。</p>
<p>分布式应用的不同进程需要相互配合和协调，才能够完成指定的任务。这就要求在承认异步的前提下，提供可靠的故障检测机制、可靠的点对点通信和群组通信、可靠的数据一致性（核心点之一是定义逻辑顺序）等。这正是分布式系统研究的核心内容。</p>
<p>再看微服务（ Microservice ）的概念。首先，「微」意味着要拆分所有的功能，且分得相对较小，再实现为对应的程序；其次，「服务」意味着这个程序有多个（种）消费者，这些消费者的编程语言、框架和支撑系统不尽相同。这就要求提供标准化的命名和发现机制、访问协议和交换数据格式。像现在流行的一种实现方式，是以 RESTful 风格 API 形式提供微服务，用 DNS 作为服务命名和发现机制， HTTP(S) 作为访问协议， JSON 作为数据格式。</p>
<p>对于一个分布式系统，在设计架构时，我们需要考虑下列问题：</p>
<ul>
<li><p>要不要拆分功能，拆分的粒度多大？</p>
</li>
<li><p>拆分后的不同组件，是部署在单机上还是多机上？</p>
</li>
<li><p>其中的一些组件，需要为多个（种）消费者提供服务吗？</p>
</li>
<li><p>各个服务间如何通信？</p>
</li>
<li><p>一个服务挂掉如何保证其他依赖此服务的服务的可用性？</p>
</li>
<li><p>分布式事务如何保证？</p>
</li>
</ul>
<p>对于初创公司，要以实现业务功能为先，此时，由于人力、财力都较少，所以适合单体应用，快速开发、部署。</p>
<p>后面随着业务的发展，人员的增加，开发、运维人员的完整，系统也逐渐发展变大，一些公共的功能可以拆分出去作为独立的服务，交由专门团队维护，这样做，一是提高复用，避免重复造轮子；二是，减少依赖；</p>
<p>再然后，业务继续发展，人员继续增加，此时我们的系统已经相当庞大了。需要将一些核心功能拆分，将大系统拆分为多个微服务，分开部署。提高开发效率。但这样不可避免的增加了运维的成本；</p>
<p>基本上，大的互联网系统都是按照上面的路子演化而来。君不见，淘宝最初也只是一个php写的bbs。</p>
<p>一个大型的分布式系统，最核心是做好下面四点：</p>
<ul>
<li><p>大规模分布式缓存系统。单靠数据库当然不可能，几台redis、mongo啥的也不够，需要上百台内存存储。并做好可靠的故障转移，冷然数据处理。</p>
</li>
<li><p>高效可靠的队列系统：亿级pv意味随时有大量数据从用户端产生，并且有一套复杂的后端系统，任意数据提交都需要考虑对这些分布式存储、服务的影响。高效可靠的队列服务必不可少。</p>
</li>
<li><p>细粒度的数据服务系统：用户数据读写、统一id生成、图片视频的写入读取、核心业务对象(例如电商商品订单)的读写都需要独立服务化与子系统化，并能与其它系统实现高效方便的rpc通讯。</p>
</li>
<li><p>强大的线上监控、部署系统。能应对突发故障、流量。</p>
</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/架构/">架构</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-100-cpu-usage-issue" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/06/20/100-cpu-usage-issue/" class="article-date">
  	<time datetime="2015-06-20T15:40:09.000Z" itemprop="datePublished">2015-06-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/20/100-cpu-usage-issue/">一次线上环境CPU过高问题解决过程</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天早晨，发现海外版的一个线上服务响应很慢，接口要刷新半天。ssh上去看了内存、磁盘都正常;用top查看cpu时发现Java进程cpu占用超过100%。tail -f 看了日志，发现几个error和warn但都感觉和cpu占用高关系不大。<br>所以初步怀疑是某些线程有问题：</p>
<ul>
<li>使用top查找出最耗cpu的进程号（PID）<br><img src="http://img2001.static.suishenyun.net/25ece6711a70a7938cb1105810f59bd3/acb9edd3e1ad94ea83e38a8ff956653e.jpg!w480.jpg" alt=""></li>
</ul>
<p>发现最占CPU的进程是 1414</p>
<ul>
<li>使用jstack dump对应PID的堆栈信息保存备查</li>
</ul>
<p>jstack是JDK内置的性能调优工具，对于分析线程堆栈非常有用。直接  jstack 1414 &gt; jstack.out</p>
<p><img src="http://img2001.static.suishenyun.net/25ece6711a70a7938cb1105810f59bd3/bcf29f1958e24af7e7bbe2172a5b658c.jpg!w480.jpg" alt=""></p>
<ul>
<li>再次使用top查出对应PID中最耗cpu的子进程（java线程）</li>
</ul>
<p>top -p 1414 -H</p>
<p><img src="http://img2001.static.suishenyun.net/25ece6711a70a7938cb1105810f59bd3/c8a8b0a93c57992b636427f96e6607ee.jpg!w480.jpg" alt=""></p>
<p>找到1462  1482 2个线程。</p>
<ul>
<li>从dump下来的堆栈信息中查找耗费性能的代码块</li>
</ul>
<p>从上面开到，我们用top找出来的pid是十进制的。而dump下来的nid是十六进制的。利用printf命令格式化来转换一下进制（当然，也可以用其他方式）：</p>
<p><img src="http://img2001.static.suishenyun.net/25ece6711a70a7938cb1105810f59bd3/e9199514d71fbe272723db9b1a17c97d.jpg!w480.jpg" alt=""></p>
<p>通过vim查找之前保存的线程堆栈信息，就能找到问题代码所在了。 </p>
<p><img src="http://img2001.static.suishenyun.net/25ece6711a70a7938cb1105810f59bd3/4ab6e1bbe2e147681deec8d615ad2721.jpg!w480.jpg" alt=""></p>
<p>发现是之前的用RabbitMQ来检查业务系统更新的线程有问题， 跟了下代码，这块逻辑之前是国内版用的，海外版有了新的接口，所以直接停掉这个后台任务，部署， cpu降下来了；<br> ​<br><img src="http://img2001.static.suishenyun.net/25ece6711a70a7938cb1105810f59bd3/b60ab6ae60752f709d0c35e7f859787f.jpg!w480.jpg" alt=""></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-the-teach-stack-of-java-backend-develop" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/06/19/the-teach-stack-of-java-backend-develop/" class="article-date">
  	<time datetime="2015-06-19T13:55:47.000Z" itemprop="datePublished">2015-06-19</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/19/the-teach-stack-of-java-backend-develop/">Java后端开发技术选型</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Web">Web</h2><ul>
<li><p>MVC Framwork： SpringMVC3.0 Restful的风格终于回归了MVC框架的简单本质，对比之下Struts2概念太复杂更新又太懒了。</p>
</li>
<li><p>Template：JSP2.0且尽量使用JSP EL而不是taglib，万一要写taglib也用纯JSP来编写，一向是SpringSide的推荐，Freemarker们始终有点小众, 而Thymeleaf与美工配合度非常高，可惜也是太少用户了。</p>
</li>
<li><p>Layout Decoration： Tiles的配置都太复杂了，<a href="https://github.com/sitemesh/sitemesh2" target="_blank" rel="external">SiteMesh2</a>好些，但Sitemesh3烂尾了。</p>
</li>
<li><p>Javascript Library： 随大流用了<a href="http://www.jquery.com/" target="_blank" rel="external">JQuery</a>。其实Dojo的面向对象语法更优美，但用户数和插件社区差了点。</p>
</li>
<li><p>CSS Framework： 最热火的<a href="http://twitter.github.com/bootstrap/" target="_blank" rel="external">Twitter Bootstrap</a>，提供了简便的布局能力和基本的页面美化。</p>
</li>
<li><p>JavaScript/CSS Compressor: 还是随便选的<a href="http://developer.yahoo.com/yui/compressor/" target="_blank" rel="external">YUI Compressor</a>。</p>
</li>
<li><p>Validation: <a href="http://jqueryvalidation.org/" target="_blank" rel="external">JQuery Validation Plugin</a>这种客户端校验的客户体验更好，而Spring MVC集成Hibernate Valiator的服务端校验则可以避免恶意用户跳过页面直接发送请求，校验规则也更多，需要混合使用。</p>
</li>
</ul>
<h2 id="WebService">WebService</h2><ul>
<li><p>SOAP WebService： JAX-WS2.0的注解 + <a href="http://cxf.apache.org/" target="_blank" rel="external">Apache CXF</a> 无疑是最成熟的，一说起Axis1/2我都要打冷颤。</p>
</li>
<li><p>Restful Service： JAX-RS 1.0 + Jersey/CXF，够标准。但直接使用Spring MVC能使架构更简单。 如果追求极致的性能标，直接写Servlet也没啥。</p>
</li>
<li><p>Restful Client: 刚出来的JAX-RS 2.0标准，实际是用Jersey的client api做蓝本的， 而直接使用Spring的RestTemplate可以减少第三方包的引入。</p>
</li>
<li><p>为了隔绝变化影响，隐藏细节，对外暴露的DTO和应用内部的领域对象是不同的类型，用<a href="http://dozer.sourceforge.net/" target="_blank" rel="external">Dozer</a>进行复制。</p>
</li>
<li><p>请求参数的校验，JSR303 Bean Validator的实现<a href="http://www.hibernate.org/subprojects/validator.html" target="_blank" rel="external">Hibernate Validator</a>没太多的竞争对手。</p>
</li>
</ul>
<h2 id="Database">Database</h2><ul>
<li><p>ORM Framework： 快速开发的应用里，领域对象肯定是用JPA标注的。至于API用Hibernate还是JPA，因为那个极简便的，DAO只要写接口就好了的<a href="http://www.springsource.org/spring-data/jpa" target="_blank" rel="external">Spring-Data-JPA</a>，所以选了<a href="http://www.hibernate.org/" target="_blank" rel="external">JPA</a>。 当然，JPA的实现还是用Hibernate。</p>
</li>
<li><p>追求高性能的应用，如各种Web服务，当然就是<a href="http://code.google.com/p/mybatis/" target="_blank" rel="external">MyBatis</a>了。如果项目再简单点，Spring JDBC其实也不错。</p>
</li>
<li><p>传统数据库: 无非Oracle与MySQL的选择，如果你恨MySQL依然是Oracle家的东西，可以考虑越来越多人用的，语法和Oracle很像的Postgresql。</p>
</li>
<li><p>NOSQL数据库: 国内用的比较多的还是<a href="http://www.redis.io/" target="_blank" rel="external">Redis</a>和MongoDB。Redis更像一个数据结构服务器，暴露各种数据结构的专有API。而MongoDB将数据存成BSON格式，也提供类似SQL的查询语句，更像一个schema-less的数据库。</p>
</li>
<li><p>数据库连接池: Apache DBCP本来一统江湖，现在被人批评又慢又复杂，所以有了<a href="http://tomcat.apache.org/tomcat-7.0-doc/jdbc-pool.html" target="_blank" rel="external">Tomcat JDBC</a>，另外温少的Druid也是一个选择。</p>
</li>
<li><p>Cache： 在JVM里的缓存，最老牌最多人用的依然是Ehcache，一些更强大的DataGrid方案如HazelCast，JBoss的Infinispan反而没什么人用。另外最简单的JVM内缓存是<a href="https://code.google.com/p/guava-libraries/wiki/CachesExplained" target="_blank" rel="external">Guava</a>的Cache。</p>
</li>
<li><p>而中央式的缓存，Memcached已经成为了事实标准。而且当主创撒手不管后，社区现在反而有着稳定的更新。 Client方面，比较稳健选择的还是Spymemcached。</p>
</li>
</ul>
<h2 id="Services">Services</h2><ul>
<li><p>Security Framework： 选择<a href="http://shiro.apache.org/" target="_blank" rel="external">Apache Shiro</a>是因为SpringSecurity的代码复杂度已经超过了它的实际需要，扩展困难痛苦。另一个原因是SpringSecurity的基本API居然只支持基于角色的判断，e.g. hasRole(“Administrator”)，而Shiro同时还支持我们其实更常用的基于Permission的判断，e.g. hasPermission(“User:Edit”)。</p>
</li>
<li><p>JMS： <a href="http://activemq.apache.org/" target="_blank" rel="external">ActiveMQ</a>是最多人选用的应用服务器无关的JMS实现，JBoss的HornetQ同样只是JBoss的用户在使用。Spring自带的JMS封装很好用。但还有更高级的如支持跨平台的AMQP协议的RabbmitMQ。</p>
</li>
<li><p>Schedule： 对于固定时间间隔的任务，JDK自带的Executor已足够好。Cron式定时执行，Spring的Scheduler也能满足。而且Spring的提供的纯XML配置也让Scheduler变得很简单，<a href="http://quartz-scheduler.org/" target="_blank" rel="external">Quartz</a>更大的优势体现在保证集群中有且仅有一台服务器执行任务。</p>
</li>
<li><p>JMX: <a href="http://www.jolokia.org/" target="_blank" rel="external">Jolokia</a>能将JMX中的MBean以Restful+JSON的方式暴露出来，使JMX这个古老的，在平台互通中显得有点封闭的协议重新焕发了青春。而Spring-Jmx将普通POJO注释一下就变成MBean也非常方便。</p>
</li>
<li><p>其他Production Feature: 用<a href="https://github.com/Netflix/Hystrix" target="_blank" rel="external">Hystrix</a>对访问资源进行并发、延时、短路控制，防止系统雪崩。</p>
</li>
</ul>
<h2 id="Utilizes">Utilizes</h2><ul>
<li><p>General： <a href="http://commons.apache.org/lang/" target="_blank" rel="external">Apache Commons Lang</a>说是伴着我们长大的也不为过，3.0版连package名也改了，全面支持泛型。 Guava 是Google新鲜推出的优雅产品。但说它会一桶天下又不定，因为它有时候太新潮了，反而用不惯。比如StringUtils我还是喜欢用Apache的，IO也同样是Apache Commons IO的好使。</p>
</li>
<li><p>XML： 用JDK自带的JAXB就算了，不折腾。</p>
</li>
<li><p>JSON： GSon虽然系出名门而且接口优雅，但<a href="http://jackson.codehaus.org/" target="_blank" rel="external">Jackson</a>的功能更加丰富到匪夷所思，而且比GSon快很多。</p>
</li>
<li><p>Email： Spring自带的Email封装挺好用的。</p>
</li>
<li><p>Logging: <a href="http://www.slf4j.org/" target="_blank" rel="external">Slf4j</a>作为入口，早就替代了Apache Common Logging了，下面的实现Log4j 1.x 被批判太多同步方法太慢，Log4j作者的后作Logback就好很多了，但社区似乎不甘心log在一家QOS公司手里，又在推动log4j2.0的发展，目前还是beta版。另外选择<a href="http://logstash.net/" target="_blank" rel="external">Logstash</a>做日志的中央式处理。</p>
</li>
<li><p>最后，Freemarker虽然不用来做页面Template，平时用来生成点东西也不错的。JodaTime这种要直接加入JDK的就不多说它了。HttpClient建议用Apache HttpClient好过JDK自带。</p>
</li>
</ul>
<h2 id="Test">Test</h2><ul>
<li><p>Unit Test： JUnit始终是正统，TestNG的功能如测试用例分组它也慢慢支持了。<a href="http://joel-costigliola.github.io/assertj/" target="_blank" rel="external">AssertJ</a> 是目前最好的Assert语句库。</p>
</li>
<li><p>Mock： Mockito的API比老牌的EasyMock更为优雅，而PowerMock则能配合Mockito完成static方法，函数内部new 出来的对象这些Mockito做不了的mock。</p>
</li>
<li><p>Functional Test：Selenium与WebDriver的合并后，最大改进是原来基于javascript的方案， 变成了直接调用浏览器的核心API，性能好了。</p>
</li>
<li><p>Performance/Stability Test: [Jmeter]作为测试工具是最成熟的，Gatling还需要时间成熟。</p>
</li>
</ul>
<h2 id="Development_Environment">Development Environment</h2><ul>
<li><p>JDK6这样没什么兼容性问题又成熟得一塌糊涂的版本建议大家都升级吧。JDK7也不错，有G1垃圾收集器和Try-Catch新语法的语法糖。</p>
</li>
<li><p>用<a href="http://www.eclipse.org/jetty/" target="_blank" rel="external">Jetty7</a>是因为它的嵌入式版本做得好，集成测试不用部署直接就开跑了。开发时一般也不用Eclipse插件，直接自己在代码里启动了，省下打包拷贝War文件的时间。Tomcat现在也有嵌入式版本了，而Jetty最新版要JDK7。</p>
</li>
<li><p>用<a href="http://www.h2database.com/" target="_blank" rel="external">H2 Database</a>，既是嵌入式的，又可以持久化到文件用Web Console查看，性能还是嵌入式中最好的。</p>
</li>
<li><p>用<a href="http://maven.apache.org/" target="_blank" rel="external">Maven</a>，在项目构建脚本不复杂的时候的首选，否则就只能ant+ivy了，或者像hibernate和spring一样，用gradle.</p>
</li>
<li><p>另外，用<a href="http://code.google.com/p/log4jdbc/" target="_blank" rel="external">Log4jdbc</a>在开发时查看实际执行的SQL。</p>
</li>
<li><p>最后，用<a href="http://www.jenkins-ci.org/" target="_blank" rel="external">Jenkins</a>做持续集成, <a href="http://www.sonarsource.org/" target="_blank" rel="external">Sonar</a>做代码质量检查，是大部分好项目的共同爱好。</p>
</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-users-buy-things" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/06/18/users-buy-things/" class="article-date">
  	<time datetime="2015-06-18T15:09:21.000Z" itemprop="datePublished">2015-06-18</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/18/users-buy-things/">电商-关于购买</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="购买的6个格式">购买的6个格式</h2><p>听说、了解、记住、喜欢、购买、传播，依此循环</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/电商/">电商</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-about-weibo" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/06/18/about-weibo/" class="article-date">
  	<time datetime="2015-06-18T14:57:43.000Z" itemprop="datePublished">2015-06-18</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/18/about-weibo/">关于社交产品</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>一个社交属性特别强大的产品的一个典型特征一定是：<strong>在这个地方能泡到妞</strong>；</p>
<p>对于这点微信是，而微博不是；</p>
<p>微博是媒体，用户在微博主要是等出事，看热闹，聊明星八卦等；</p>
<p>微信的社交属性就强的多，朋友圈、IM是熟人交流；漂流瓶、附近的人、摇一摇是陌生人社交；</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/随笔/">随笔</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-the-google-mirror" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/06/17/the-google-mirror/" class="article-date">
  	<time datetime="2015-06-17T15:07:06.000Z" itemprop="datePublished">2015-06-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/17/the-google-mirror/">Google 镜像站搜集</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>以下镜像站分原版和非原版，非原版界面有些改变，搜索结果依然是相同的。【来源自互联网】</p>
<p>非原版：</p>
<ul>
<li>Glgoo：<a href="http://www.glgoo.com/" target="_blank" rel="external">http://www.glgoo.com/</a></li>
<li>九尾搜索：<a href="http://www.jwss.com/" target="_blank" rel="external">http://www.jwss.com/</a></li>
<li>谷粉搜搜：<a href="http://www.gfsswy.com/" target="_blank" rel="external">http://www.gfsswy.com/</a></li>
<li>谷粉搜搜：<a href="http://gufensoso.com/" target="_blank" rel="external">http://gufensoso.com/</a></li>
<li>谷粉恰搜：<a href="http://www.qiasou.com/" target="_blank" rel="external">http://www.qiasou.com/</a></li>
<li>蝴蝶：<a href="http://www.xiexingwen.com/" target="_blank" rel="external">http://www.xiexingwen.com/</a></li>
<li>一哥搜：<a href="http://www.egeso.com/" target="_blank" rel="external">http://www.egeso.com/</a></li>
<li>谷歌搜：<a href="http://www.gugesou.com/" target="_blank" rel="external">http://www.gugesou.com/</a></li>
<li>谷壳：<a href="http://www.googke.me/" target="_blank" rel="external">http://www.googke.me/</a></li>
<li>南搜：<a href="http://nan.so/" target="_blank" rel="external">http://nan.so/</a></li>
<li>白鸽：<a href="http://baigeso.com/" target="_blank" rel="external">http://baigeso.com/</a></li>
<li>GG搜索：<a href="http://ggsousuo.duapp.com/" target="_blank" rel="external">http://ggsousuo.duapp.com/</a></li>
<li>大中华：<a href="http://i.forbook.net/" target="_blank" rel="external">http://i.forbook.net/</a></li>
<li>红杏谷歌：<a href="http://www.hxgoogle.com/" target="_blank" rel="external">http://www.hxgoogle.com/</a></li>
<li>逆天谷歌：<a href="http://www.go2121.com/" target="_blank" rel="external">http://www.go2121.com/</a></li>
<li>谷歌363：<a href="http://www.g363.com/" target="_blank" rel="external">http://www.g363.com/</a></li>
<li>FKDD：<a href="http://fkdd.com/" target="_blank" rel="external">http://fkdd.com/</a></li>
<li>OpenGG：<a href="http://www.opengg.cn/" target="_blank" rel="external">http://www.opengg.cn/</a></li>
<li>Avira：<a href="https://safesearch.avira.com/" target="_blank" rel="external">https://safesearch.avira.com/</a></li>
<li>Suche：<a href="http://suche.web.de/" target="_blank" rel="external">http://suche.web.de/</a></li>
<li>WOW：<a href="http://www.wow.com/" target="_blank" rel="external">http://www.wow.com/</a></li>
<li>Ask：<a href="http://home.tb.ask.com/" target="_blank" rel="external">http://home.tb.ask.com/</a></li>
<li>Googleout：<a href="https://www.out1000.com/" target="_blank" rel="external">https://www.out1000.com/</a></li>
<li>WebWebWeb：<a href="http://webwebweb.com/" target="_blank" rel="external">http://webwebweb.com/</a></li>
<li>Disconnect：<a href="https://search.disconnect.me/" target="_blank" rel="external">https://search.disconnect.me/</a></li>
</ul>
<p>原版：</p>
<ul>
<li><a href="http://carbyne.net.cn/" target="_blank" rel="external">http://carbyne.net.cn/</a></li>
<li><a href="http://g.itechzero.com/" target="_blank" rel="external">http://g.itechzero.com/</a></li>
<li><a href="https://g.wen.lu/" target="_blank" rel="external">https://g.wen.lu/</a></li>
<li><a href="https://s.ets.cc/" target="_blank" rel="external">https://s.ets.cc/</a></li>
<li><a href="https://www.90r.org/" target="_blank" rel="external">https://www.90r.org/</a></li>
<li><a href="https://guge.io/" target="_blank" rel="external">https://guge.io/</a></li>
<li><a href="https://sepu.org/" target="_blank" rel="external">https://sepu.org/</a></li>
<li><a href="https://gg.avpn.cc/" target="_blank" rel="external">https://gg.avpn.cc/</a></li>
<li><a href="https://g4w.me/" target="_blank" rel="external">https://g4w.me/</a></li>
<li><a href="https://s.bt.gg/" target="_blank" rel="external">https://s.bt.gg/</a></li>
<li><a href="https://duliziyou.com/" target="_blank" rel="external">https://duliziyou.com/</a></li>
<li><a href="https://www.booo.so/" target="_blank" rel="external">https://www.booo.so/</a></li>
<li><a href="https://www.muzhiso.com/" target="_blank" rel="external">https://www.muzhiso.com/</a></li>
<li><a href="http://google1314.com/" target="_blank" rel="external">http://google1314.com/</a></li>
<li><a href="http://gl.randomk.org/" target="_blank" rel="external">http://gl.randomk.org/</a></li>
<li><a href="https://www.ggncr.com/" target="_blank" rel="external">https://www.ggncr.com/</a></li>
<li><a href="https://g.ftfish.com/" target="_blank" rel="external">https://g.ftfish.com/</a></li>
<li><a href="https://allee.science/" target="_blank" rel="external">https://allee.science/</a></li>
<li><a href="http://www.kb58.cn/" target="_blank" rel="external">http://www.kb58.cn/</a></li>
<li><a href="http://google.ihuan.me/" target="_blank" rel="external">http://google.ihuan.me/</a></li>
<li><a href="http://discus.cf/" target="_blank" rel="external">http://discus.cf/</a></li>
<li><a href="https://laoshandaoshi.so/" target="_blank" rel="external">https://laoshandaoshi.so/</a></li>
<li><a href="https://www.gotosearch.info/" target="_blank" rel="external">https://www.gotosearch.info/</a></li>
<li><a href="http://www.googlestable.cn/" target="_blank" rel="external">http://www.googlestable.cn/</a></li>
<li><a href="http://www.googleforchina.com/" target="_blank" rel="external">http://www.googleforchina.com/</a></li>
<li><a href="http://0s.o53xo.m5xw6z3mmuxgizi.erenta.ru/" target="_blank" rel="external">http://0s.o53xo.m5xw6z3mmuxgizi.erenta.ru/</a></li>
</ul>
<p>IP直连：</p>
<ul>
<li><a href="http://4.31.38.26/" target="_blank" rel="external">http://4.31.38.26/</a></li>
<li><a href="http://4.31.38.27/" target="_blank" rel="external">http://4.31.38.27/</a></li>
<li><a href="http://4.31.38.31/" target="_blank" rel="external">http://4.31.38.31/</a></li>
<li><a href="http://58.123.102.23/" target="_blank" rel="external">http://58.123.102.23/</a></li>
<li><a href="http://64.233.189.163/" target="_blank" rel="external">http://64.233.189.163/</a></li>
<li><a href="http://66.185.84.19/" target="_blank" rel="external">http://66.185.84.19/</a></li>
<li><a href="http://74.125.102.230/" target="_blank" rel="external">http://74.125.102.230/</a></li>
<li><a href="http://74.125.104.113/" target="_blank" rel="external">http://74.125.104.113/</a></li>
<li><a href="http://91.213.30.153/" target="_blank" rel="external">http://91.213.30.153/</a></li>
<li><a href="http://95.173.210.55/" target="_blank" rel="external">http://95.173.210.55/</a></li>
<li><a href="http://118.174.27.112/" target="_blank" rel="external">http://118.174.27.112/</a></li>
<li><a href="http://173.194.1.13/" target="_blank" rel="external">http://173.194.1.13/</a></li>
<li><a href="http://173.194.14.40/" target="_blank" rel="external">http://173.194.14.40/</a></li>
<li><a href="http://173.194.14.41/" target="_blank" rel="external">http://173.194.14.41/</a></li>
<li><a href="http://173.194.14.50/" target="_blank" rel="external">http://173.194.14.50/</a></li>
<li><a href="http://173.194.14.52/" target="_blank" rel="external">http://173.194.14.52/</a></li>
<li><a href="http://173.194.138.103/" target="_blank" rel="external">http://173.194.138.103/</a></li>
<li><a href="http://201.163.0.13/" target="_blank" rel="external">http://201.163.0.13/</a></li>
<li><a href="http://202.152.192.171/" target="_blank" rel="external">http://202.152.192.171/</a></li>
<li><a href="http://203.211.0.100/" target="_blank" rel="external">http://203.211.0.100/</a></li>
<li><a href="http://209.85.225.23/" target="_blank" rel="external">http://209.85.225.23/</a></li>
<li><a href="http://209.85.226.146/" target="_blank" rel="external">http://209.85.226.146/</a></li>
<li><a href="http://209.85.228.11/" target="_blank" rel="external">http://209.85.228.11/</a></li>
<li><a href="http://209.85.228.19/" target="_blank" rel="external">http://209.85.228.19/</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/收藏/">收藏</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-redis-install-and-config" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/06/16/redis-install-and-config/" class="article-date">
  	<time datetime="2015-06-16T15:41:59.000Z" itemprop="datePublished">2015-06-16</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/16/redis-install-and-config/">在Ubuntu系统中安装/卸载Redis</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="安装Redis服务器端">安装Redis服务器端</h2><pre><code>sudo apt-get <span class="operator"><span class="keyword">install</span> redis-<span class="keyword">server</span></span>
</code></pre><p>安装完成后，Redis服务器会自动启动，我们可以检查Redis服务器程序：</p>
<h3 id="检查Redis服务器系统进程">检查Redis服务器系统进程</h3><pre><code><span class="keyword">ps</span> -aux|<span class="keyword">grep</span> redis
</code></pre><p>redis     4162  0.1  0.0  10676  1420 ?        Ss   23:24   0:00 /usr/bin/</p>
<pre><code>redis-<span class="keyword">server</span> /etc/redis/redis.conf
</code></pre><p>conan     4172  0.0  0.0  11064   924 pts/0    S+   23:26   0:00 grep —color=auto redis</p>
<h4 id="通过启动命令检查Redis服务器状态">通过启动命令检查Redis服务器状态</h4><pre><code>netstat -nlt<span class="string">|grep 6379</span>
</code></pre><p>tcp        0      0 127.0.0.1:6379          0.0.0.0:*               LISTEN</p>
<h4 id="通过启动命令检查Redis服务器状态-1">通过启动命令检查Redis服务器状态</h4><pre><code>sudo /etc/init.d/redis-<span class="keyword">server</span> status
</code></pre><p>redis-server is running</p>
<h2 id="卸载Redis">卸载Redis</h2><pre><code>sudo apt-<span class="keyword">get</span> purge <span class="comment">--auto-remove redis-server</span>
</code></pre>
      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NoSQL/">NoSQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-apache-httpclient4-pool" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/06/14/apache-httpclient4-pool/" class="article-date">
  	<time datetime="2015-06-14T13:26:47.000Z" itemprop="datePublished">2015-06-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/14/apache-httpclient4-pool/">HttpClient4.0 Http连接池</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>连接池技术作为创建和管理连接的缓冲池技术，目前已广泛用于诸如数据库连接等长连接的维护和管理中，能够有效减少系统的响应时间，节省服务器资源开销。其优势主要有两个：其一是减少创建连接的资源开销，其二是资源的访问控制。连接池管理的对象是长连接，对于HTTP连接是否适用，我们需要首先回顾一下长连接和短连接。</p>
<p>所谓长连接是指客户端与服务器端一旦建立连接以后，可以进行多次数据传输而不需重新建立连接，而短连接则每次数据传输都需要客户端和服务器端建立一次连接。长连接的优势在于省去了每次数据传输连接建立的时间开销，能够大幅度提高数据传输的速度，对于P2P应用十分适合，但是对于诸如Web网站之类的B2C应用，并发请求量大，每一个用户又不需频繁的操作的场景下，维护大量的长连接对服务器无疑是一个巨大的考验。而此时，短连接可能更加适用。但是短连接每次数据传输都需要建立连接，我们知道HTTP协议的传输层协议是TCP协议，TCP连接的建立和释放分别需要进行3次握手和4次握手，频繁的建立连接即增加了时间开销，同时频繁的创建和销毁Socket同样是对服务器端资源的浪费。所以对于需要频繁发送HTTP请求的应用，需要在客户端使用HTTP长连接。</p>
<p>HTTP连接是无状态的，这样很容易给我们造成HTTP连接是短连接的错觉，实际上HTTP1.1默认即是持久连接，HTTP1.0也可以通过在请求头中设置Connection:keep-alive使得连接为长连接。既然HTTP协议支持长连接，我们就有理由相信HTTP连接同样需要连接池技术来管理和维护连接建立和销毁。HTTP Client4.0的ThreadSafeClientConnManager实现了HTTP连接的池化管理，其管理连接的基本单位是Route（路由），每个路由上都会维护一定数量的HTTP连接。这里的Route的概念可以理解为客户端机器到目标机器的一条线路，例如使用HttpClient的实现来分别请求 www.163.com 的资源和 www.sina.com 的资源就会产生两个route。缺省条件下对于每个Route，HttpClient仅维护2个连接，总数不超过20个连接，显然对于大多数应用来讲，都是不够用的，可以通过设置HTTP参数进行调整。</p>
<pre><code>HttpParams params = new BasicHttpParams<span class="params">()</span>;
<span class="comment">//将每个路由的最大连接数增加到200</span>
ConnManagerParams.setMaxTotalConnections<span class="params">(params,<span class="number">200</span>)</span>;
<span class="comment">// 将每个路由的默认连接数设置为20</span>
ConnPerRouteBean connPerRoute = new ConnPerRouteBean<span class="params">(<span class="number">20</span>)</span>;
<span class="comment">// 设置某一个IP的最大连接数</span>
HttpHost localhost = new HttpHost<span class="params">(<span class="string">"locahost"</span>, <span class="number">80</span>)</span>;
connPerRoute.setMaxForRoute<span class="params">(new HttpRoute<span class="params">(localhost)</span>, <span class="number">50</span>)</span>;
ConnManagerParams.setMaxConnectionsPerRoute<span class="params">(params, connPerRoute)</span>;
SchemeRegistry schemeRegistry = new SchemeRegistry<span class="params">()</span>;
schemeRegistry.register<span class="params">(
new Scheme<span class="params">(<span class="string">"http"</span>, PlainSocketFactory.getSocketFactory<span class="params">()</span>, <span class="number">80</span>)</span>)</span>;
schemeRegistry.register<span class="params">(
new Scheme<span class="params">(<span class="string">"https"</span>, SSLSocketFactory.getSocketFactory<span class="params">()</span>, <span class="number">443</span>)</span>)</span>;
ClientConnectionManager cm = new ThreadSafeClientConnManager<span class="params">(params, schemeRegistry)</span>;
HttpClient httpClient = new DefaultHttpClient<span class="params">(cm, params)</span>;
</code></pre><p>可以配置的HTTP参数有：</p>
<p> 1、 http.conn-manager.timeout 当某一线程向连接池请求分配线程时，如果连接池已经没有可以分配的连接时，该线程将会被阻塞，直至http.conn-manager.timeout超时，抛出ConnectionPoolTimeoutException。</p>
<p> 2、 http.conn-manager.max-per-route 每个路由的最大连接数； </p>
<p> 3、 http.conn-manager.max-total 总的连接数；</p>
<p>连接的有效性检测是所有连接池都面临的一个通用问题，大部分HTTP服务器为了控制资源开销，并不会永久的维护一个长连接，而是一段时间就会关闭该连接。放回连接池的连接，如果在服务器端已经关闭，客户端是无法检测到这个状态变化而及时的关闭Socket的。这就造成了线程从连接池中获取的连接不一定是有效的。这个问题的一个解决方法就是在每次请求之前检查该连接是否已经存在了过长时间，可能已过期。但是这个方法会使得每次请求都增加额外的开销。HTTP Client4.0的ThreadSafeClientConnManager 提供了<br>closeExpiredConnections()方法和closeIdleConnections()方法来解决该问题。前一个方法是清除连接池中所有过期的连接，至于连接什么时候过期可以设置，设置方法将在下面提到，而后一个方法则是关闭一定时间空闲的连接，可以使用一个单独的线程完成这个工作。</p>
<pre><code><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IdleConnectionMonitorThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>{
    <span class="keyword">private</span> <span class="keyword">final</span> ClientConnectionManager connMgr;
    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> shutdown;
    <span class="function"><span class="keyword">public</span> <span class="title">IdleConnectionMonitorThread</span><span class="params">(ClientConnectionManager connMgr)</span> </span>{
        <span class="keyword">super</span>();
        <span class="keyword">this</span>.connMgr = connMgr;
    }
    <span class="annotation">@Override</span>
    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{
        <span class="keyword">try</span> {
            <span class="keyword">while</span> (!shutdown) {
                <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {
                    wait(<span class="number">5000</span>);
                    <span class="comment">// 关闭过期的连接</span>
                    connMgr.closeExpiredConnections();
                    <span class="comment">// 关闭空闲时间超过30秒的连接</span>
                    connMgr.closeIdleConnections(<span class="number">30</span>, TimeUnit.SECONDS);
                }
            }
        } <span class="keyword">catch</span> (InterruptedException ex) {
            <span class="comment">// terminate</span>
        }
    }
    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>{
        shutdown = <span class="keyword">true</span>;
        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {
        notifyAll();
    }
}
</code></pre><p>刚才提到，客户端可以设置连接的过期时间，可以通过HttpClient的setKeepAliveStrategy方法设置连接的过期时间，这样就可以配合closeExpiredConnections()方法解决连接池中连接失效的。</p>
<pre><code>DefaultHttpClient httpclient = <span class="keyword">new</span> DefaultHttpClient();
httpclient.setKeepAliveStrategy(<span class="keyword">new</span> ConnectionKeepAliveStrategy() {
    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getKeepAliveDuration</span>(<span class="params">HttpResponse response, HttpContext context</span>) </span>{
        <span class="comment">// Honor 'keep-alive' header</span>
        HeaderElementIterator it = <span class="keyword">new</span> BasicHeaderElementIterator(
        response.headerIterator(HTTP.CONN_KEEP_ALIVE));
        <span class="keyword">while</span> (it.hasNext()) {
            HeaderElement he = it.nextElement();
            String param = he.getName();
            String <span class="keyword">value</span> = he.getValue();
            <span class="keyword">if</span> (<span class="keyword">value</span> != <span class="keyword">null</span> &amp;&amp; param.equalsIgnoreCase(<span class="string">"timeout"</span>)) {
                <span class="keyword">try</span> {
                    <span class="keyword">return</span> Long.parseLong(<span class="keyword">value</span>) * <span class="number">1000</span>;
                } <span class="keyword">catch</span>(NumberFormatException ignore) {
                }
            }
        }
    HttpHost target = (HttpHost) context.getAttribute(
    ExecutionContext.HTTP_TARGET_HOST);
    <span class="keyword">if</span> (<span class="string">"www.qq.com"</span>.equalsIgnoreCase(target.getHostName())) {
        <span class="comment">// 对于qq这个路由的连接，保持5秒</span>
        <span class="keyword">return</span> <span class="number">5</span> * <span class="number">1000</span>;
    } <span class="keyword">else</span> {
        <span class="comment">// 其他路由保持30秒</span>
        <span class="keyword">return</span> <span class="number">30</span> * <span class="number">1000</span>;
    }
}
});
</code></pre>
      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端技术/">后端技术</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-about-arch-design" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/06/09/about-arch-design/" class="article-date">
  	<time datetime="2015-06-08T16:31:42.000Z" itemprop="datePublished">2015-06-09</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/09/about-arch-design/">架构随想</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>架构师其实不是建筑设计师，画完图让工人去施工；而是园艺师，要播种、灌溉、剪枝、一直呵护着，让系统不断成长；</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/架构/">架构</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2015 fwwdn
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: undefined,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: undefined
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>